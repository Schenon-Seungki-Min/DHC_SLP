import PptxGenJS from 'pptxgenjs';
import type { ResearchData } from './types';

export function generatePPT(data: ResearchData, topic: string): PptxGenJS {
  const pptx = new PptxGenJS();

  // ìŠ¬ë¼ì´ë“œ ì¶”ê°€
  const slide = pptx.addSlide();

  // ë°°ê²½ìƒ‰ ì„¤ì •
  slide.background = { color: 'FFFFFF' };

  // íƒ€ì´í‹€
  slide.addText(topic, {
    x: 0.5,
    y: 0.5,
    w: 9,
    h: 0.8,
    fontSize: 28,
    bold: true,
    color: '1F4788',
    align: 'left',
  });

  // ìƒì„± ì •ë³´
  const today = new Date().toLocaleDateString('ko-KR');
  slide.addText(`Generated by KKAM_BIZ | ${today}`, {
    x: 0.5,
    y: 1.2,
    w: 9,
    h: 0.4,
    fontSize: 12,
    color: '666666',
    align: 'left',
  });

  // êµ¬ë¶„ì„ 
  slide.addShape(pptx.ShapeType.rect, {
    x: 0.5,
    y: 1.8,
    w: 9,
    h: 0.02,
    fill: { color: 'CCCCCC' },
  });

  // í•µì‹¬ íŠ¸ë Œë“œ ì„¹ì…˜
  slide.addText('ðŸ“Š í•µì‹¬ íŠ¸ë Œë“œ', {
    x: 0.5,
    y: 2.1,
    w: 9,
    h: 0.5,
    fontSize: 20,
    bold: true,
    color: '1F4788',
  });

  // íŠ¸ë Œë“œ ëª©ë¡
  let yPosition = 2.7;
  data.trends.slice(0, 3).forEach((trend, index) => {
    // íŠ¸ë Œë“œ ì œëª©
    slide.addText(`${index + 1}. ${trend.title}`, {
      x: 0.7,
      y: yPosition,
      w: 8.5,
      h: 0.4,
      fontSize: 16,
      bold: true,
      color: '333333',
    });

    // íŠ¸ë Œë“œ ì„¤ëª…
    slide.addText(`- ${trend.description}`, {
      x: 0.9,
      y: yPosition + 0.4,
      w: 8.3,
      h: 0.5,
      fontSize: 12,
      color: '666666',
    });

    yPosition += 1.1;
  });

  // ì‹œì‚¬ì  ì„¹ì…˜
  slide.addText('ðŸ’¡ So What? (ì‹œì‚¬ì )', {
    x: 0.5,
    y: yPosition + 0.2,
    w: 9,
    h: 0.5,
    fontSize: 20,
    bold: true,
    color: '1F4788',
  });

  // ì‹œì‚¬ì  ëª©ë¡
  let insightY = yPosition + 0.8;
  data.insights.slice(0, 2).forEach((insight) => {
    slide.addText(`- ${insight}`, {
      x: 0.7,
      y: insightY,
      w: 8.5,
      h: 0.4,
      fontSize: 12,
      color: '333333',
    });
    insightY += 0.45;
  });

  // ì¶œì²˜
  const sources = data.sources.slice(0, 3).map((s) => s.title || s.url).join(', ');
  slide.addText(`ðŸ“Ž ì¶œì²˜: ${sources}`, {
    x: 0.5,
    y: 7,
    w: 9,
    h: 0.4,
    fontSize: 10,
    color: '999999',
  });

  return pptx;
}
